@using App_UI.Resource.ViewText.Common
@using App_UI.Resource.ViewText.Produce
@using Model
@{
    ViewBag.Title = "加工产品交仓单一览";
}
@section head
{
    <script src="~/Scripts/common/dialog.js" type="text/javascript"></script>
    <link rel="stylesheet" href="~/Content/css/Produce/InProcessingWarehouseList.css" />

    <script>
        //改变日期格式
        function changeDate(value) {
            var date;
            var strDt = (value + "").replace(/\/Date\(/, "").replace(/\)\//, "");
            if (isNaN(strDt)) {
                date = strDt.ToDate();
            } else {
                date = new Date(strDt.ToInt());
            }
            var str = date.Format("yyyy-MM-dd");
            return str;
        }

        //搜索功能
        var searchFun = function() {
            $("#searchForm").form("submit", {
                //form提交
                url: "/Produce/InProcessingWarehouseList/GetData",
                onSubmit: function(param) { //除表单外的数据(分页)
                    var pager = $("#proProWarTable").datagrid("getPager");
                    var pagerOptions = $(pager).pagination("options");
                    param.rows = pagerOptions.pageSize;
                    param.page = 1;
                },
                success: function(data) {
                    $("#proProWarTable").datagrid("loadData", eval('(' + data + ')')); //重新加载数据
                }
            });
        };

        //删除选中的一条或多条数据
        var deleteFun = function() {
            var row = $("#proProWarTable").datagrid('getSelections');
            if (row.length > 0) {
                var check = "";
                for (var i = 0; i < row.length; i++) {
                    check += row[i].ProcDelivID + ",";
                }
                check = check.substring(0, check.length - 1);
                $.messager.confirm("@VT_Common.Tips", "@VT_Common.ConfirmDelete", function(deleteOK) {
                    if (deleteOK) {
                        $.post("/Produce/InProcessingWarehouseList/Delete", { procDelivId: check }, function(data) {
                            var _data = eval('(' + data + ')');
                            if (_data.Result == true) {
                                $("#proProWarTable").datagrid("reload");
                            }
                            $.messager.alert("@VT_Common.Info", _data.Message);
                        });
                    }
                });
            } else {
                $.messager.alert("@VT_Common.Tips", "@VT_Common.PleaseSelect");
            }
        };

        //交仓单一览详细
        toDetailFun = function (procDelivID) {
            parent.addTab("@VT_InProcessingWarehouseList.InProWarListDet", "/Produce/InProcessingWarehouseList/Detail/?procDelivID=" + procDelivID);
        };


        //打印预览
        var printPreview = function (id) {
            parent.addTab("@VT_InProcessingWarehouseList.PrintViewTitle", "/Produce/InProcessingWarehouseList/PrintPreview?procDelivID=" + id);
        };

        //关闭当前标签
        var closeFun = function() {
            parent.closeTab();
        };

        /***********放大镜功能 开始***************/

        //点击产品型号(即产品略称)放大镜
        var ShowProdPartInfoScreenByAbbrev = function () {
            ShowProdPartInfo("ProdPartSelectDiv", "", $("#txtPartName").val());
        };

        /***********放大镜功能 结束***************/

        (function($) {

            var table = "#proProWarTable";
            var form = "#searchForm";

            var getColumns = function() {
                var columns = [[]];
                //["field", "title", "width", "sortable", "editor", "formatter"]
                columns[0].push(["ProcDelivID", "@VT_InProcessingWarehouseList.ProcDelivID", 150, false, null, function (value, row, index) {
                    var htmlStr = "";
                    htmlStr += ("<a href='#' onclick='printPreview(" + "\"" + value + "\"" + ")';" + ">" + value + "</a>");
                    return htmlStr;
                }]);
                columns[0].push(["ProcessTranID", "@VT_InProcessingWarehouseList.ProcessTranID", 180]);
                columns[0].push(["PartName", "@VT_InProcessingWarehouseList.PartName", 120]);
                columns[0].push(["SubItemName", "@VT_InProcessingWarehouseList.SubItemName", 120]);
                columns[0].push(["WarehQtySubmitted", "@VT_InProcessingWarehouseList.WarehQtySubmitted", 70]);
                columns[0].push(["WarehouseStatus", "@VT_InProcessingWarehouseList.WarehouseStatus", 80]);
                columns[0].push(["ConcessionPart", "@VT_InProcessingWarehouseList.ConcessionPart", 80]);
                columns[0].push(["BillDt", "@VT_InProcessingWarehouseList.BillDt", 90, false, null, function (value, row) {
                    return changeDate(value);
                }]);
                columns[0].push(["Detail", "@VT_InProcessingWarehouseList.Detail", 90, false, null, function (value, row) {
                    return "<input type='button' value='@VT_InProcessingWarehouseList.DetailInformation' onclick=\"toDetailFun('" + row.ProcDelivID + "')\"/>";
                }]);
                return columns;
            };

            $(function() {
                Common.Functions.createDataGrid({
                    target: table,
                    url: "/Produce/InProcessingWarehouseList/GetData",
                    columns: getColumns(),
                    idField: "ProcDelivID",//标识字段
                    checkbox: true,
                    //pagination: true,
                    sortName: "",
                    sortOrder: "",//默认排序
                    maxWidth: 1030,//最大宽度
                    maxHeight: 600,//最大高 度
                    onBeforeLoad: function(queryParams) { //可以添加一些额外参数,主要用于查询条件
                        var arr = $("#searchForm").serializeArray();
                        $.each(arr, function() {
                            queryParams[this.name] = this.value;
                        });
                    }
                    //loadFilter: function(data) {
                    //    var _data = {};
                    //    _data.rows = data.rows ? data.rows : data;
                    //    _data.total = data.total ? data.total : _data.rows.length;
                    //    return _data;
                    //}
                });
                $("#btnClose").bind('click', closeFun);
                $("#btnSearch").bind('click', searchFun);
                $("#btnDelete").bind('click', deleteFun);
            });


        }(jQuery));
    </script>
}


<div class="buttons" style="width: 100%; text-align: right; margin-top: 10px;">
    @UserHelpers.ButtonForDelete("", "btnDelete")
    @UserHelpers.ButtonForClose("", "btnClose")

</div>



@UserHelpers.Line()
@UserHelpers.Company_Title(VT_Common.CompanyName)
@UserHelpers.Title(VT_InProcessingWarehouseList.IIndexTitle)
<br/>

<div style="width: 100%; margin-bottom: 10px;">
    <form id="searchForm" method="post" class="Search_Form" style="text-align: center;">
        <div style="width: 800px; margin: auto; text-align: left;">
            <table style="width: 100%;">
                <tr>
                    <td>@VT_InProcessingWarehouseList.ProcDelivID：@UserHelpers.InputSimple("txtProcDelivID",new {size=20,maxlength=20})</td>
                    <td>@VT_InProcessingWarehouseList.ProcessTranID：@UserHelpers.InputSimple("txtProcessTranID",new {size=20,maxlength=20})</td>                    
                    <td>@VT_InProcessingWarehouseList.PartName：@UserHelpers.Input("txtPartName",200,200,"ShowProdPartInfoScreenByAbbrev()")</td>
                    <td>@VT_InProcessingWarehouseList.WarehouseStatus：@UserHelpers.Select(Constant.Warehouse.WAREH_STA_SECTION_CD, "txtWarehouseStatus", "txtWarehouseStatus")
                    </td>
                </tr>
                <tr>
                    <td colspan="2">@VT_InProcessingWarehouseList.BillDt：@UserHelpers.TimeBeginInput("txtBillStartDt", "txtBillStartDt","txtBillStartDt")~@UserHelpers.TimeEndInput("txtBillEndDt", "txtBillEndDt","txtBillEndDt")</td>
                    <td style="margin-left: 338px; text-align: right" colspan="2">@UserHelpers.ButtonForSearch("", "btnSearch")</td>
                </tr>
            </table>
        </div>
    </form>

</div>

<div class="datagrid" style="text-align: center; width: 100%;">
    <table id="proProWarTable"></table>
</div>

<!-- *************************************************************** 子查询画面START ******************************************************** -->
<!-- Dialog -->
<!-- 物料选择对话框 -->
<div class="easyui-dialog" id="ProdPartSelectDiv" closed="true" data-options="buttons:'#prodPartSelect',modal:true"></div>
<div id="prodPartSelect">
    @UserHelpers.ButtonForChoose("SelProdPartAndCloseDialogFun('', 'txtPartName', 'txtPartName', '0', 'ProdPartSelectDiv')")
    @UserHelpers.ButtonForClose("CloseDialogFun('ProdPartSelectDiv')")
</div>
<!-- *************************************************************** 子查询画面END ******************************************************** -->
